<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LEAF Dashboard</title>
<link rel="icon" href="./logo.png" type="image/png">
<script src="/socket.io/socket.io.js"></script>
<style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

:root {
--primary-bg: #faf9f5;
--secondary-bg: #ffffff;
--card-bg: #ffffff;
--border-color: #e5e7eb;
--text-primary: #1f2937;
--text-secondary: #6b7280;
--text-muted: #9ca3af;
--accent-color: #059669;
--accent-hover: #047857;
--success-color: #10b981;
--warning-color: #f59e0b;
--error-color: #ef4444;
--shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
--shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
--radius-sm: 0.375rem;
--radius-md: 0.5rem;
--radius-lg: 0.75rem;
--header-footer-bg: #1a1a1a;
--header-footer-text: #ffffff;
}

@media (prefers-color-scheme: dark) {
 :root {
   --primary-bg: #1a1a1a;
   --secondary-bg: #2d2d2d;
   --card-bg: #2d2d2d;
   --border-color: #4a4a4a;
   --text-primary: #e0e0e0;
   --text-secondary: #b0b0b0;
   --text-muted: #8a8a8a;
   --accent-color: #059669;
   --accent-hover: #047857;
   --success-color: #10b981;
   --warning-color: #f59e0b;
   --error-color: #ef4444;
   --header-footer-bg: #1a1a1a;
   --header-footer-text: #ffffff;
 }
 .chat-filter-buttons select.active-filter,
 .chat-filter-buttons .date-picker-wrapper.active-filter {
   border-color: white;
 }
}

body {
font-family: "Inter", -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
background-color: var(--primary-bg);
color: var(--text-primary);
line-height: 1.6;
transition: all 0.2s ease;
}

.container {
max-width: 1200px;
margin: 0 auto;
padding: 0 1.5rem;
}

header {
background-color: var(--header-footer-bg);
border-bottom: 1px solid var(--border-color);
padding: 1rem 0;
position: sticky;
top: 0;
z-index: 100;
backdrop-filter: blur(10px);
color: var(--header-footer-text);
}

.header-content {
display: flex;
align-items: center;
justify-content: space-between;
}

.logo-section {
display: flex;
align-items: center;
gap: 0.75rem;
}

.logo {
width: 40px;
height: 40px;
border-radius: var(--radius-md);
display: flex;
align-items: center;
justify-content: center;
overflow: hidden;
}

.logo img {
width: 100%;
height: 100%;
object-fit: cover;
}

.brand {
font-size: 1.5rem;
font-weight: 700;
color: var(--header-footer-text);
}

.status-indicator {
display: flex;
align-items: center;
gap: 0.5rem;
padding: 0.5rem 1rem;
background-color: var(--success-color);
color: white;
border-radius: var(--radius-md);
font-size: 0.875rem;
font-weight: 500;
}

.status-dot {
width: 8px;
height: 8px;
background-color: currentColor;
border-radius: 50%;
animation: pulse 2s infinite;
}

@keyframes pulse {
0%, 100% { opacity: 1; }
50% { opacity: 0.5; }
}

main {
padding: 2rem 0;
}

.hero-section {
text-align: center;
margin-bottom: 3rem;
}

.hero-title {
font-size: 2.5rem;
font-weight: 800;
margin-bottom: 0.5rem;
color: var(--text-primary);
}
.hero-subtitle {
font-size: 1.125rem;
color: var(--text-secondary);
margin-bottom: 1rem;
}

.stats-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
gap: 1.5rem;
margin-bottom: 2rem;
}

.stat-card {
background-color: var(--card-bg);
border: 1px solid var(--border-color);
border-radius: var(--radius-lg);
padding: 1.5rem;
box-shadow: var(--shadow-sm);
transition: all 0.2s ease;
}

.stat-card:hover {
box-shadow: var(--shadow-md);
transform: translateY(-1px);
}

.stat-header {
display: flex;
align-items: center;
justify-content: space-between;
margin-bottom: 1rem;
}

.stat-title {
font-size: 0.875rem;
font-weight: 500;
color: var(--text-secondary);
text-transform: uppercase;
letter-spacing: 0.05em;
}

.stat-icon {
width: 20px;
height: 20px;
color: var(--accent-color);
}

.stat-value {
font-size: 2rem;
font-weight: 700;
color: var(--text-primary);
margin-bottom: 0.25rem;
}

.stat-label {
font-size: 0.875rem;
color: var(--text-muted);
}

.info-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
gap: 1.5rem;
margin-bottom: 2rem;
}

.info-card {
background-color: var(--card-bg);
border: 1px solid var(--border-color);
border-radius: var(--radius-lg);
padding: 1.5rem;
box-shadow: var(--shadow-sm);
}

.info-card h3 {
font-size: 1.125rem;
font-weight: 600;
margin-bottom: 1rem;
display: flex;
align-items: center;
gap: 0.5rem;
}

.info-list {
list-style: none;
}

.info-item {
display: flex;
justify-content: space-between;
align-items: center;
padding: 0.75rem 0;
border-bottom: 1px solid var(--border-color);
}

.info-item:last-child {
border-bottom: 0;
}

.info-label {
font-size: 0.875rem;
color: var(--text-secondary);
}

.info-value {
font-size: 0.875rem;
font-weight: 500;
color: var(--text-primary);
}

.badge {
display: inline-flex;
align-items: center;
gap: 0.25rem;
padding: 0.25rem 0.75rem;
border-radius: var(--radius-sm);
font-size: 0.75rem;
font-weight: 500;
text-transform: uppercase;
letter-spacing: 0.05em;
}

.badge-success {
background-color: rgba(16, 185, 129, 0.1);
color: var(--success-color);
}

.badge-warning {
background-color: rgba(245, 158, 11, 0.1);
color: var(--warning-color);
}

.badge-error {
background-color: rgba(239, 68, 68, 0.1);
color: var(--error-color);
}

footer {
margin-top: 4rem;
padding: 2rem 0;
background-color: var(--header-footer-bg);
border-top: none;
text-align: center;
color: var(--header-footer-text);
}

footer .logo-brand-container {
display: flex;
align-items: center;
justify-content: center;
margin-bottom: 0.5rem;
}

footer .logo-footer {
width: 40px;
height: 40px;
margin-right: 10px;
border-radius: var(--radius-md);
object-fit: cover;
}

footer .brand-footer {
font-size: 1.5rem;
font-weight: 700;
color: var(--header-footer-text);
}

.copyright-text {
font-size: 0.875rem;
font-weight: 400;
color: var(--header-footer-text);
}

.loading {
display: inline-block;
width: 1rem;
height: 1rem;
border: 2px solid var(--border-color);
border-radius: 50%;
border-top: 2px solid var(--accent-color);
animation: spin 1s linear infinite;
}

@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}

.player-list-container {
margin-top: 1.5rem;
max-height: 200px;
overflow-y: auto;
padding-right: 10px;
}

.player-list-item {
display: flex;
align-items: center;
gap: 0.75rem;
padding: 0.5rem 0;
border-bottom: 1px dashed var(--border-color);
}

.player-list-item:last-child {
border-bottom: none;
}

.player-skin-face {
width: 24px;
height: 24px;
border-radius: 4px;
background-color: #f0f0f0;
flex-shrink: 0;
}

.player-skin-face img {
width: 100%;
height: 100%;
object-fit: cover;
border-radius: inherit;
}

.chat-section {
background-color: var(--card-bg);
border: 1px solid var(--border-color);
border-radius: var(--radius-lg);
padding: 1.5rem;
box-shadow: var(--shadow-sm);
margin-top: 2rem;
}

.chat-header {
margin-bottom: 1rem;
}

.chat-header h3 {
font-size: 1.125rem;
font-weight: 600;
display: flex;
align-items: center;
gap: 0.5rem;
margin-bottom: 1rem;
}

.chat-controls {
display: flex;
flex-direction: column;
gap: 0.75rem;
margin-bottom: 1rem;
}

.chat-search-container {
position: relative;
width: 100%;
}

.chat-search-container input[type="search"] {
width: 100%;
padding: 0.75rem 0.75rem 0.75rem 2.5rem;
border: 1px solid var(--border-color);
border-radius: var(--radius-md);
font-size: 0.875rem;
color: var(--text-primary);
background-color: var(--primary-bg);
}

.chat-search-container .search-icon {
position: absolute;
left: 0.75rem;
top: 50%;
transform: translateY(-50%);
color: var(--text-muted);
width: 18px;
height: 18px;
}

.chat-filter-buttons {
display: flex;
gap: 0.5rem;
width: 100%;
}

.chat-filter-buttons select,
.chat-filter-buttons .date-picker-wrapper {
 flex: 1;
 display: flex;
 align-items: center;
 justify-content: center;
 padding: 0.75rem 0.75rem;
 border: 1px solid var(--border-color);
 border-radius: var(--radius-md);
 font-size: 0.875rem;
 color: var(--text-primary);
 background-color: var(--primary-bg);
 cursor: pointer;
 min-width: 120px;
 transition: none;
}
.chat-filter-buttons select {
-webkit-appearance: none;
-moz-appearance: none;
appearance: none;
background-image: none;
font-weight: 500;
text-align: center;
}


.chat-filter-buttons select.active-filter,
.chat-filter-buttons .date-picker-wrapper.active-filter {
 border-color: black;
}

.chat-filter-buttons select:hover,
.chat-filter-buttons .date-picker-wrapper:hover {
 background-color: transparent;
}

.date-picker-wrapper {
position: relative;
display: flex;
align-items: center;
justify-content: center;
gap: 0.5rem;
}

.date-picker-wrapper input[type="date"] {
position: absolute;
top: 0;
left: 0;
width: 100%;
height: 100%;
opacity: 0;
cursor: pointer;
}

.date-picker-wrapper .calendar-icon {
position: relative;
top: -1px;
color: var(--text-muted);
width: 18px;
height: 18px;
}

.date-picker-wrapper .date-text {
 font-weight: 500;
 min-width: 80px;
 display: inline-block;
 text-align: center;
}

.date-picker-wrapper .vertical-border {
height: 1.2em;
width: 1px;
background-color: var(--border-color);
margin: 0 0.25rem;
}

.chat-messages {
max-height: 400px;
overflow-y: auto;
border: 1px solid var(--border-color);
border-radius: var(--radius-md);
padding: 1rem;
background-color: var(--primary-bg);
display: flex;
flex-direction: column-reverse;
scroll-behavior: auto;
}

.chat-message-item {
display: flex;
flex-direction: column;
align-items: flex-start;
gap: 0.25rem;
margin-bottom: 1rem;
padding-bottom: 1rem;
/* Removed default border-bottom here */
}

.chat-message-item:last-child {
margin-bottom: 0;
padding-bottom: 0;
}

.chat-message-item.minute-separator {
 border-bottom: 1px solid var(--border-color);
}

.chat-message-header {
display: flex;
align-items: center;
gap: 0.75rem;
margin-bottom: 0.25rem;
}

.chat-avatar {
width: 32px;
height: 32px;
border-radius: 4px; /* Changed from 50% to 4px */
flex-shrink: 0;
overflow: hidden;
background-color: #f0f0f0;
}

.chat-avatar img {
width: 100%;
height: 100%;
object-fit: cover;
border-radius: inherit;
}

.chat-username {
font-weight: 600;
color: var(--text-primary);
}

.chat-text {
color: var(--text-secondary);
word-wrap: break-word;
margin-left: 40px;
}

.chat-timestamp {
font-size: 0.75rem;
color: var(--text-muted);
margin-top: 0.25rem;
margin-left: 40px;
}

.minecraft-time-display {
display: flex;
align-items: center;
gap: 0.5rem;
flex-wrap: wrap;
}

.minecraft-time-display .time-icon-text {
display: flex;
align-items: center;
gap: 0.5rem;
}

.minecraft-time-icon {
width: 24px;
height: 24px;
color: var(--accent-color);
}

@media (min-width: 768px) {
.stats-grid {
 grid-template-columns: repeat(4, 1fr);
}

.info-grid {
 grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
}

.stats-grid > :nth-child(4) {
 grid-column: span 1;
}

.info-grid > :nth-child(3) {
 grid-column: span 2;
}

.chat-controls {
 flex-direction: row;
 justify-content: space-between;
 align-items: center;
}

.chat-search-container {
 flex: 1;
 max-width: calc(100% - 220px);
}

.chat-filter-buttons {
 width: auto;
 flex: none;
}
}

@media (max-width: 767px) {
.hero-title {
 font-size: 2rem;
}

.stats-grid {
 grid-template-columns: 1fr;
}

.container {
 padding: 0 1rem;
}

.chat-controls {
 flex-direction: column;
 align-items: stretch;
}

footer .logo-footer {
 width: 30px;
 height: 30px;
 margin-right: 8px;
}

footer .brand-footer {
 font-size: 1.25rem;
}
}
</style>
</head>
<body>
<header>
<div class="container">
<div class="header-content">
 <div class="logo-section">
     <div class="logo" id="logo">
         <img src="./logo.png" alt="Leaf Logo" onerror="this.onerror=null;this.src='https://placehold.co/40x40/059669/ffffff?text=L';" />
     </div>
     <div class="brand">LEAF</div>
 </div>
 <div class="status-indicator" id="status-indicator">
     <div class="status-dot"></div>
     <span id="status-text">Loading...</span>
 </div>
</div>
</div>
</header>

<main>
<div class="container">
<div class="hero-section">
 <h1 class="hero-title">DASHBOARD</h1>
 <p class="hero-subtitle">Real-time monitoring</p>
</div>

<div class="stats-grid">
 <div class="stat-card">
     <div class="stat-header">
         <div class="stat-title">Online Players</div>
         <svg class="stat-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0z"></path>
         </svg>
     </div>
     <div class="stat-value" id="player-count">
         <div class="loading"></div>
     </div>
     <div class="stat-label">Connected players</div>
     <div class="player-list-container" id="player-list-container">
     </div>
 </div>

 <div class="stat-card">
     <div class="stat-header">
         <div class="stat-title">Uptime</div>
         <svg class="stat-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
         </svg>
     </div>
     <div class="stat-value" id="uptime">
         <div class="loading"></div>
     </div>
     <div class="stat-label">Time online</div>
 </div>

 <div class="stat-card">
     <div class="stat-header">
         <div class="stat-title">Movements</div>
         <svg class="stat-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
         </svg>
     </div>
     <div class="stat-value" id="movements">
         <div class="loading"></div>
     </div>
     <div class="stat-label">Total actions</div>
 </div>

 <div class="stat-card">
     <div class="stat-header">
         <div class="stat-title">Memory Usage</div>
         <svg class="stat-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"></path>
         </svg>
     </div>
     <div class="stat-value" id="memory">
         <div class="loading"></div>
     </div>
     <div class="stat-label">RAM consumption</div>
 </div>
</div>

<div class="info-grid">
 <div class="info-card">
     <h3>
         <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
         </svg>
         Bot Status
     </h3>
     <ul class="info-list">
         <li class="info-item">
             <span class="info-label">Bot Name</span>
             <span class="info-value" id="bot-name">
                 <div class="loading"></div>
             </span>
         </li>
         <li class="info-item">
             <span class="info-label">Game Mode</span>
             <span class="info-value" id="game-mode">
                 <div class="loading"></div>
             </span>
         </li>
         <li class="info-item">
             <span class="info-label">Position (X, Y, Z)</span>
             <span class="info-value" id="position">
                 <div class="loading"></div>
             </span>
         </li>
         <li class="info-item">
             <span class="info-label">Health</span>
             <span class="info-value" id="bot-health">
                 <div class="loading"></div>
             </span>
         </li>
         <li class="info-item">
             <span class="info-label">Food</span>
             <span class="info-value" id="bot-food">
                 <div class="loading"></div>
             </span>
         </li>
         <li class="info-item">
             <span class="info-label">Network Latency</span>
             <span class="info-value" id="bot-latency">
                 <div class="loading"></div>
             </span>
         </li>
     </ul>
 </div>

 <div class="info-card">
     <h3>
         <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
         </svg>
         Server Info
     </h3>
     <ul class="info-list">
         <li class="info-item">
             <span class="info-label">Server IP</span>
             <span class="info-value" id="server-ip">
                 <div class="loading"></div>
             </span>
         </li>
         <li class="info-item">
             <span class="info-label">Server Port</span>
             <span class="info-value" id="server-port">
                 <div class="loading"></div>
             </span>
         </li>
         <li class="info-item">
             <span class="info-label">Server Load (1m)</span>
             <span class="info-value" id="server-load">
                 <div class="loading"></div>
             </span>
         </li>
         <li class="info-item">
             <span class="info-label">CPU Usage</span>
             <span class="info-value" id="cpu-usage">
                 <div class="loading"></div>
             </span>
         </li>
         <li class="info-item">
             <span class="info-label">Disk Free</span>
             <span class="info-value" id="disk-free">
                 <div class="loading"></div>
             </span>
         </li>
         <li class="info-item">
             <span class="info-label">Disk Total</span>
             <span class="info-value" id="disk-total">
                 <div class="loading"></div>
             </span>
         </li>
         <li class="info-item">
             <span class="info-label">Status</span>
             <span class="info-value">
                 <span class="badge badge-success" id="status-badge">
                     <svg width="12" height="12" fill="currentColor" viewBox="0 0 20 20">
                         <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                     </svg>
                     Online
                 </span>
             </span>
         </li>
         <li class="info-item">
             <span class="info-label">Last Updated</span>
             <span class="info-value" id="last-updated">Just now</span>
         </li>
         <li class="info-item">
             <span class="info-label">Last Online</span>
             <span class="info-value" id="last-online">Never</span>
         </li>
     </ul>
 </div>

 <div class="info-card">
     <h3>
         <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
         </svg>
         Minecraft Game Data
     </h3>
     <ul class="info-list">
         <li class="info-item">
             <span class="info-label">Minecraft Day</span>
             <span class="info-value" id="minecraft-day">
                 <div class="loading"></div>
             </span>
         </li>
         <li class="info-item">
             <span class="info-label">Minecraft Time</span>
             <span class="info-value" id="minecraft-time">
                 <div class="loading"></div>
             </span>
         </li>
         <li class="info-item">
             <span class="info-label">Server Difficulty</span>
             <span class="info-value" id="server-difficulty">
                 <div class="loading"></div>
             </span>
         </li>
     </ul>
 </div>
</div>

<div class="chat-section">
 <div class="chat-header">
     <h3>
         <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
         </svg>
         In-game Chat
     </h3>
     <div class="chat-controls">
         <div class="chat-search-container">
             <input type="search" id="chat-search" placeholder="">
             <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
             </svg>
         </div>
         <div class="chat-filter-buttons">
             <select id="chat-sort-username">
                 <option value="">All Users</option>
             </select>
             <div class="date-picker-wrapper" id="date-filter-wrapper">
                 <span id="chat-date-display" class="date-text">Date</span>
                 <div class="vertical-border"></div>
                 <svg class="calendar-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24"
stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
<rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
<path d="M3 10h18"/>
                 </svg>
                 <input type="date" id="chat-sort-date">
             </div>
         </div>
     </div>
 </div>
 <div class="chat-messages" id="chat-messages">
     <p class="info-label" style="text-align: center; margin-top: 1rem;">Loading chat...</p>
 </div>
</div>
</div>
</main>

<footer>
<div class="container">
<div class="logo-brand-container">
 <img src="./logo.png" alt="Leaf Logo" class="logo-footer" onerror="this.onerror=null;this.src='https://placehold.co/40x40/059669/ffffff?text=L';" />
 <span class="brand-footer">LeafSMP</span>
</div>
<p class="copyright-text">©<span id="current-year"></span> LeafSMP</p>
</div>
</footer>

<script>
const socket = io();

let chatMessagesSkip = 0;
let chatMessagesLimit = 50;
let chatLoading = false;
let chatEndReached = false;

function formatUptime(seconds) {
const hours = Math.floor(seconds / 3600);
const minutes = Math.floor((seconds % 3600) / 60);
const remainingSeconds = seconds % 60;

if (hours > 0) {
return `${hours}h ${minutes}m`;
} else if (minutes > 0) {
return `${minutes}m ${remainingSeconds}s`;
} else {
return `${remainingSeconds}s`;
}
}

function getMinecraftTimeDetails(ticks) {
let timeOfDay = 'Midday';
let exactTime = '';

const hours = Math.floor((ticks / 1000 + 6) % 24);
const minutes = Math.floor(((ticks % 1000) / 1000) * 60);
const ampm = hours >= 12 ? 'PM' : 'AM';
const displayHours = hours % 12 === 0 ? 12 : hours % 12;
exactTime = `${displayHours}:${minutes.toString().padStart(2, '0')} ${ampm}`;

return { timeOfDay, exactTime };
}

function updateStatus(data) {
const statusIndicator = document.getElementById('status-indicator');
const statusText = document.getElementById('status-text');
const statusBadge = document.getElementById('status-badge');
const chatMessagesContainer = document.getElementById('chat-messages');

if (data.message.includes('running')) {
statusIndicator.style.backgroundColor = '#10b981';
statusText.textContent = 'Online';
statusBadge.className = 'badge badge-success';
statusBadge.innerHTML = `
    <svg width="12" height="12" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
    </svg>
    Online
`;
if (chatMessagesContainer.innerHTML.includes("Bot is offline, no chat history available.")) {
    chatMessagesContainer.innerHTML = '<p class="info-label" style="text-align: center; margin-top: 1rem;">No chat available.</p>';
}
} else {
statusIndicator.style.backgroundColor = '#ef4444';
statusText.textContent = 'Offline';
statusBadge.className = 'badge badge-error';
statusBadge.innerHTML = `
    <svg width="12" height="12" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
    </svg>
    Offline
`;
chatMessagesContainer.innerHTML = '<p class="info-label" style="text-align: center; margin-top: 1rem;">Bot is offline, no chat history available.</p>';
}

document.getElementById('player-count').textContent = data.onlinePlayersCount || 0;
document.getElementById('uptime').textContent = formatUptime(data.uptime || 0);
document.getElementById('movements').textContent = (data.movements || 0).toLocaleString();
document.getElementById('memory').textContent = data.memoryUsage || '0 MB';

document.getElementById('bot-name').textContent = data.botName || 'N/A';
document.getElementById('game-mode').textContent = 'Spectator';
document.getElementById('position').textContent = data.position
? `${data.position.x}, ${data.position.y}, ${data.position.z}`
: 'Unknown';
document.getElementById('bot-health').textContent = data.botHealth || 'N/A';
document.getElementById('bot-food').textContent = data.botFood || 'N/A';
document.getElementById('bot-latency').textContent = data.botLatency || 'N/A';

document.getElementById('server-ip').textContent = data.serverHost || 'N/A';
document.getElementById('server-port').textContent = data.serverPort || 'N/A';
document.getElementById('server-load').textContent = data.serverLoad || 'N/A';
document.getElementById('cpu-usage').textContent = `${data.cpuUsage || '0.00'}%`;
document.getElementById('disk-free').textContent = data.diskFree || '0.00 GB';
document.getElementById('disk-total').textContent = data.diskTotal || '0.00 GB';

document.getElementById('minecraft-day').textContent = data.minecraftDay !== 'N/A' ? `Day ${data.minecraftDay}` : 'N/A';

const minecraftTimeElement = document.getElementById('minecraft-time');
if (data.minecraftTime !== 'N/A') {
const { timeOfDay, exactTime } = getMinecraftTimeDetails(data.minecraftTime);
minecraftTimeElement.innerHTML = `
    <div class="minecraft-time-display">
        <div class="time-icon-text">
            ${timeOfDay}
        </div>
        <div>Live time: ${exactTime}</div>
    </div>
`;
} else {
minecraftTimeElement.innerHTML = 'N/A';
}

document.getElementById('server-difficulty').textContent = data.serverDifficulty !== 'N/A' ? data.serverDifficulty : 'N/A';

document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
document.getElementById('last-online').textContent = data.lastOnline ? new Date(data.lastOnline).toLocaleString() : 'Never';

const playerListContainer = document.getElementById('player-list-container');
playerListContainer.innerHTML = '';
if (data.playerDetails && data.playerDetails.length > 0) {
data.playerDetails.forEach(player => {
    const playerDiv = document.createElement('div');
    playerDiv.className = 'player-list-item';
    playerDiv.innerHTML = `
        <div class="player-skin-face">
            <img src="${player.skinUrl}" alt="${player.username} skin" onerror="this.onerror=null;this.src='https://placehold.co/24x24/cccccc/000000?text=?';">
        </div>
        <span>${player.username} (Ping: ${player.ping})</span>
    `;
    playerListContainer.appendChild(playerDiv);
});
} else {
playerListContainer.innerHTML = '<p class="info-label" style="text-align: center; margin-top: 1rem;">No players online</p>';
}
}

function addChatMessage(message) {
 const chatMessagesContainer = document.getElementById('chat-messages');
 const messageDiv = document.createElement('div');
 messageDiv.className = 'chat-message-item';
 messageDiv.dataset.timestamp = message.timestamp;

 const date = new Date(message.timestamp);
 const formattedDate = date.toLocaleDateString('en-US', {
     year: 'numeric', month: '2-digit', day: '2-digit'
 });
 const formattedTime = date.toLocaleTimeString([], {
     hour: '2-digit', minute: '2-digit', hour12: true
 });

 messageDiv.innerHTML = `
     <div class="chat-message-header">
         <div class="chat-avatar">
             <img src="${message.skinUrl}" alt="${message.username} skin" onerror="this.onerror=null;this.src='https://placehold.co/32x32/cccccc/000000?text=?';">
         </div>
         <div class="chat-username">${message.username}</div>
     </div>
     <div class="chat-text">${message.chat}</div>
     <div class="chat-timestamp">${formattedDate} ${formattedTime}</div>
 `;
 chatMessagesContainer.appendChild(messageDiv);
}

function applyChatBorders() {
 const chatMessagesContainer = document.getElementById('chat-messages');
 const messageItems = chatMessagesContainer.children;

 for (let i = 0; i < messageItems.length; i++) {
   const currentMsgElement = messageItems[i];
   const currentTimestamp = new Date(currentMsgElement.dataset.timestamp);

   currentMsgElement.classList.remove('minute-separator');

   if (i < messageItems.length - 1) {
     const nextMsgElement = messageItems[i + 1];
     const nextTimestamp = new Date(nextMsgElement.dataset.timestamp);

     const currentMinute = currentTimestamp.getFullYear() + '-' + currentTimestamp.getMonth() + '-' + currentTimestamp.getDate() + ' ' + currentTimestamp.getHours() + ':' + currentTimestamp.getMinutes();
     const nextMinute = nextTimestamp.getFullYear() + '-' + nextTimestamp.getMonth() + '-' + nextTimestamp.getDate() + ' ' + nextTimestamp.getHours() + ':' + nextTimestamp.getMinutes();

     if (currentMinute !== nextMinute) {
       currentMsgElement.classList.add('minute-separator');
     }
   } else {
     currentMsgElement.classList.add('minute-separator');
   }
 }
}


async function fetchChatHistory() {
if (chatLoading || chatEndReached) return;
chatLoading = true;

const chatMessagesContainer = document.getElementById('chat-messages');
const isInitialLoad = chatMessagesSkip === 0;
if (isInitialLoad) {
 chatMessagesContainer.innerHTML = '<p class="info-label" style="text-align: center; margin-top: 1rem;" id="chat-status-message">Fetching chats...</p>';
}

const usernameFilter = document.getElementById('chat-sort-username').value || '';
const dateFilter = document.getElementById('chat-sort-date').value;
const searchFilter = document.getElementById('chat-search').value;

let url = `/api/chat?skip=${chatMessagesSkip}&limit=${chatMessagesLimit}&`;
if (usernameFilter) url += `username=${usernameFilter}&`;
if (dateFilter) url += `date=${dateFilter}&`;
if (searchFilter) url += `search=${searchFilter}&`;
url = url.slice(0, -1);

try {
 await new Promise(resolve => setTimeout(resolve, 2000));

 const response = await fetch(url);
 const messages = await response.json();

 if (isInitialLoad) {
   chatMessagesContainer.innerHTML = '';
 }

 if (messages.length === 0) {
   chatEndReached = true;
   if (isInitialLoad) {
     chatMessagesContainer.innerHTML = '<p class="info-label" style="text-align: center; margin-top: 1rem;">No chat available.</p>';
   }
   return;
 }

 messages.forEach(msg => addChatMessage(msg));
 applyChatBorders();

 chatMessagesSkip += messages.length;

 if (isInitialLoad) {
   chatMessagesContainer.scrollTop = 0;
 }

} catch (error) {
console.error('Error fetching chat history:', error);
if (chatMessagesSkip === 0) {
chatMessagesContainer.innerHTML = '<p class="info-label" style="text-align: center; margin-top: 1rem;">Error loading chat history.</p>';
}
} finally {
chatLoading = false;
}
}

async function populateUsernameDropdown() {
try {
const response = await fetch('/api/chat/usernames');
const usernames = await response.json();
const usernameSelect = document.getElementById('chat-sort-username');

usernameSelect.innerHTML = '<option value="">All Users</option>';

usernames.forEach(username => {
    const option = document.createElement('option');
    option.value = username;
    option.textContent = username;
    usernameSelect.appendChild(option);
});
} catch (error) {
console.error('Error fetching usernames:', error);
}
}

function handleError() {
console.log("Error handling function called.");
}

document.addEventListener('DOMContentLoaded', () => {
document.getElementById('current-year').textContent = new Date().getFullYear();

document.getElementById('chat-search').addEventListener('input', () => {
chatMessagesSkip = 0;
chatEndReached = false;
document.getElementById('chat-messages').innerHTML = '';
fetchChatHistory();
});

const usernameSelect = document.getElementById('chat-sort-username');
const dateSortDateInput = document.getElementById('chat-sort-date');
const chatDateDisplay = document.getElementById('chat-date-display');

usernameSelect.addEventListener('change', () => {
chatMessagesSkip = 0;
chatEndReached = false;
document.getElementById('chat-messages').innerHTML = '';
fetchChatHistory();
});

dateSortDateInput.addEventListener('change', (event) => {
const selectedDate = event.target.value;
if (selectedDate) {
    chatDateDisplay.textContent = new Date(selectedDate).toLocaleDateString('en-US', { year: 'numeric', month: '2-digit', day: '2-digit' });
} else {
    chatDateDisplay.textContent = 'Date';
}
chatMessagesSkip = 0;
chatEndReached = false;
document.getElementById('chat-messages').innerHTML = '';
fetchChatHistory();
});

populateUsernameDropdown();
fetchChatHistory();

document.getElementById('chat-messages').addEventListener('scroll', () => {
const container = document.getElementById('chat-messages');
if (container.scrollTop + container.clientHeight >= container.scrollHeight - 20 && !chatLoading && !chatEndReached) {
fetchChatHistory();
}
});
});

socket.on('botStatusUpdate', (data) => {
updateStatus(data);
});

socket.on('chatMessage', (message) => {
const usernameFilter = document.getElementById('chat-sort-username').value || '';
const dateFilter = document.getElementById('chat-sort-date').value;
const searchFilter = document.getElementById('chat-search').value;

const messageDate = new Date(message.timestamp).toISOString().split('T')[0];

const matchesUsername = !usernameFilter || message.username === usernameFilter;
const matchesDate = !dateFilter || messageDate === dateFilter;
const matchesSearch = !searchFilter || message.chat.toLowerCase().includes(searchFilter.toLowerCase());

if (matchesUsername && matchesDate && matchesSearch) {
const chatMessagesContainer = document.getElementById('chat-messages');
const noChatAvailableMessage = chatMessagesContainer.querySelector('#chat-status-message');
if (noChatAvailableMessage) {
   noChatAvailableMessage.remove();
}
addChatMessage(message);
applyChatBorders(); // Reapply borders after adding new message
chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
}
});

handleError();
</script>
</body>
</html>
